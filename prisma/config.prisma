
// ============================================
// ADMIN & OPERATIONS
// ============================================

model AdminNote {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  orderId       String?  @db.ObjectId
  order         Order?   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  userId        String?  @db.ObjectId
  user          User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdById   String   @db.ObjectId
  createdBy     User     @relation(fields: [createdById], references: [id])
  
  note          String
  isInternal    Boolean  @default(true) // Internal vs customer-visible
  category      String? // issue, follow_up, payment, etc.
  
  createdAt      DateTime @default(now())
  
  @@index([orderId])
  @@index([userId])
  @@index([createdAt])
  @@map("admin_notes")
}

model ActivityLog {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String?  @db.ObjectId
  user          User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  orderId       String?  @db.ObjectId
  order         Order?   @relation(fields: [orderId], references: [id], onDelete: SetNull)
  
  action        String // order_created, status_changed, payment_received, etc.
  entityType    String // order, payment, vehicle, user, etc.
  entityId      String?
  description   String
  metadata      Json? // Additional context
  
  performedBy   String?  @db.ObjectId // Admin who performed action
  ipAddress     String?
  userAgent     String?
  
  createdAt      DateTime @default(now())
  
  @@index([userId])
  @@index([orderId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("activity_logs")
}

// ============================================
// CONFIGURATION & SETTINGS
// ============================================

model PricingConfig {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  name          String
  country       String   @default("Nigeria")
  isActive      Boolean  @default(true)
  
  // Pricing Structure (flexible JSON)
  config        Json // {
  //   sourcing_fee_percent, sourcing_fee_min_usd,
  //   inspection_fee_usd, shipping_roro_base_usd,
  //   customs_duty_percent, vat_percent, etc.
  // }
  
  // Exchange Rates
  exchangeRates  Json? // { USD: { NGN: 1550, GHS: 12.5 }, ... }
  lastRateUpdate DateTime?
  
  // Timelines
  estimatedTimelines Json? // { roro: 45, container: 60 }
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  updatedBy     String?  @db.ObjectId
  
  @@unique([country, isActive])
  @@index([country])
  @@index([isActive])
  @@map("pricing_configs")
}

model SystemSetting {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  key           String   @unique
  value         Json
  category      String? // payment, shipping, api, notification, etc.
  description   String?
  isPublic      Boolean  @default(false) // Can be accessed without auth
  
  updatedAt     DateTime @updatedAt
  updatedBy     String?  @db.ObjectId
  
  @@index([key])
  @@index([category])
  @@map("system_settings")
}

// ============================================
// API INTEGRATION TRACKING
// ============================================

model ApiIntegration {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  provider      String   // autodev, etc.
  apiKey        String?  // Encrypted
  apiSecret     String?  // Encrypted
  baseUrl       String
  isActive      Boolean  @default(true)
  
  // Rate Limiting
  rateLimit     Int? // Requests per minute
  rateLimitWindow Int? // Window in seconds
  currentRequests Int @default(0)
  lastResetAt   DateTime?
  
  // Monitoring
  totalRequests Int      @default(0)
  successfulRequests Int @default(0)
  failedRequests Int    @default(0)
  lastRequestAt DateTime?
  lastError      String?
  lastErrorAt    DateTime?
  
  // Configuration
  config        Json? // Provider-specific config
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([provider])
  @@index([isActive])
  @@map("api_integrations")
}

model ApiRequestLog {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  integrationId String  @db.ObjectId
  integration   ApiIntegration @relation(fields: [integrationId], references: [id])
  
  endpoint      String
  method        String
  statusCode    Int?
  success       Boolean
  responseTime  Int? // milliseconds
  errorMessage  String?
  
  requestData   Json?
  responseData  Json? // Truncated for storage
  
  createdAt     DateTime @default(now())
  
  @@index([integrationId])
  @@index([success])
  @@index([createdAt])
  @@map("api_request_logs")
}
